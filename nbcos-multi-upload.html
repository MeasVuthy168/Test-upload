
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Excel File Processor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    #fileInput {
      margin-bottom: 20px;
    }
    #spinner {
      display: none;
      margin: 20px 0;
      font-weight: bold;
      color: #007BFF;
    }
    #results {
      margin-top: 20px;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
  </style>
</head>
<body>

  <h1>Excel File Processor</h1>
  <input type="file" id="fileInput" multiple accept=".xlsx, .xls" />
  <div id="spinner">Processing files, please wait...</div>
  <div id="results"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const spinner = document.getElementById('spinner');
    const results = document.getElementById('results');
    const CHUNK_SIZE = 3000;

    fileInput.addEventListener('change', handleFiles);

    function handleFiles(event) {
      const files = event.target.files;
      if (!files.length) return;

      results.innerHTML = '';
      spinner.style.display = 'block';

      const filePromises = Array.from(files).map(file => processFile(file));

      Promise.all(filePromises)
        .then(() => {
          spinner.style.display = 'none';
        })
        .catch(error => {
          spinner.style.display = 'none';
          results.innerHTML += `<div class="error">Error: ${error.message}</div>`;
        });
    }

    function processFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (!jsonData.length) {
              results.innerHTML += `<div class="error">File "${file.name}" is empty.</div>`;
              return resolve();
            }

            const headers = jsonData[0];
            if (headers[0] !== 'LD_CIF_OS') {
              results.innerHTML += `<div class="error">File "${file.name}" does not have 'LD_CIF_OS' as the first column.</div>`;
              return resolve();
            }

            const dataRows = jsonData.slice(1);
            const totalRows = dataRows.length;

            if (totalRows <= CHUNK_SIZE) {
              results.innerHTML += `<div class="success">File "${file.name}" processed with ${totalRows} rows.</div>`;
            } else {
              const numChunks = Math.ceil(totalRows / CHUNK_SIZE);
              for (let i = 0; i < numChunks; i++) {
                const chunkData = dataRows.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                const chunkArray = [headers, ...chunkData];
                const worksheetChunk = XLSX.utils.aoa_to_sheet(chunkArray);
                const workbookChunk = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbookChunk, worksheetChunk, 'Sheet1');
                const chunkBlob = XLSX.write(workbookChunk, { bookType: 'xlsx', type: 'blob' });
                const chunkFileName = `${file.name.replace(/\.xlsx?$/, '')}_part${i + 1}.xlsx`;
                downloadBlob(chunkBlob, chunkFileName);
              }
              results.innerHTML += `<div class="success">File "${file.name}" split into ${numChunks} files.</div>`;
            }

            resolve();
          } catch (err) {
            reject(err);
          }
        };

        reader.onerror = function() {
          reject(new Error(`Failed to read file "${file.name}".`));
        };

        reader.readAsArrayBuffer(file);
      });
    }

    function downloadBlob(blob, fileName) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>

</body>
</html>
